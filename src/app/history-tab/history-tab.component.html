<div class="space-y-3 text-xs">

  <!-- No sessions yet -->
  <div
    *ngIf="sessions.length === 0"
    class="bg-slate-800 rounded-xl p-3 text-[11px] text-slate-200">
    No sessions saved yet. Create one from the Session tab with the wizard.
  </div>

  <!-- Sessions list (HIDDEN when a session is opened) -->
  <div
    *ngIf="sessions.length > 0 && !editSession"
    class="bg-slate-800 rounded-xl p-3 space-y-2">
    <h2 class="text-sm font-semibold mb-1">History</h2>

    <div
      *ngFor="let s of sessions"
      class="bg-slate-900 rounded-xl p-2 flex items-center justify-between gap-2"
      [class.border]="selectedSessionId === s.id"
      [class.border-emerald-500]="selectedSessionId === s.id">

      <div class="flex-1">
        <div class="flex items-center gap-2">
          <div class="text-[11px] font-semibold">
            {{ s.title || 'Untitled session' }}
          </div>
          <span
            class="px-2 py-[2px] rounded-full text-[10px] font-semibold"
            [ngClass]="getStatusClass(s)">
            {{ getStatusLabel(s) }}
          </span>
        </div>
        <div class="text-[10px] text-slate-300">
          {{ s.date | date: 'yyyy-MM-dd HH:mm' }} •
          {{ getRifleName(s.rifleId) }} @ {{ getVenueName(s.venueId) }}
        </div>
      </div>

      <div class="flex gap-2 text-[11px]">
        <button
          class="px-2 py-1 rounded bg-slate-700"
          (click)="selectSession(s)">
          Open
        </button>
        <button
          class="px-2 py-1 rounded bg-red-600"
          (click)="deleteSession(s)">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Detailed view for selected session (only this shows when open) -->
  <div *ngIf="editSession" class="bg-slate-800 rounded-xl p-3 space-y-3">

    <!-- Light red notice when session is still planned -->
    <div
      *ngIf="!editSession.completed"
      class="mb-2 bg-rose-900/40 border border-rose-500 text-[11px] text-rose-100 rounded-lg p-2">
      This session only has planned data. Enter your actual dope and press
      <strong>Close</strong> when done. (Changes are kept automatically.)
    </div>

    <div class="flex justify-between items-center">
      <div>
        <div class="text-sm font-semibold">
          {{ editSession.title || 'Untitled session' }}
        </div>
        <div class="text-[10px] text-slate-300">
          {{ editSession.date | date: 'yyyy-MM-dd HH:mm' }} •
          {{ getRifleName(editSession.rifleId) }} @
          {{ getVenueName(editSession.venueId) }}
        </div>
      </div>
      <span
        class="px-2 py-[2px] rounded-full text-[10px] font-semibold"
        [ngClass]="getStatusClass(editSession)">
        {{ getStatusLabel(editSession) }}
      </span>
    </div>

    <!-- Environment summary -->
    <div class="bg-slate-900 rounded-lg p-2 space-y-1">
      <div class="text-[11px] font-semibold">Environment (recorded)</div>
      <div class="grid grid-cols-2 gap-1 text-[10px] text-slate-300">
        <div *ngIf="editSession.environment.temperatureC != null">
          Temp: {{ editSession.environment.temperatureC }} °C
        </div>
        <div *ngIf="editSession.environment.pressureHpa != null">
          Pressure: {{ editSession.environment.pressureHpa }} hPa
        </div>
        <div *ngIf="editSession.environment.humidityPercent != null">
          Humidity: {{ editSession.environment.humidityPercent }} %
        </div>
        <div *ngIf="editSession.environment.densityAltitudeM != null">
          DA: {{ editSession.environment.densityAltitudeM }} m
        </div>
        <div *ngIf="editSession.environment.windSpeedMps != null">
          Wind: {{ editSession.environment.windSpeedMps }} m/s
        </div>
        <div *ngIf="editSession.environment.windDirectionDeg != null">
          Wind dir: {{ editSession.environment.windDirectionDeg }} °
        </div>
        <div *ngIf="editSession.environment.lightConditions">
          Light: {{ editSession.environment.lightConditions }}
        </div>
      </div>
    </div>

    <!-- Actual dope entry – ULTRA COMPACT table layout -->
    <div class="space-y-1">
      <div class="text-[11px] font-semibold">Actual dope &amp; results</div>

      <div class="bg-slate-900 rounded-lg p-2 space-y-0">

        <!-- Table header -->
        <div
          class="grid grid-cols-[60px,1fr,1fr] gap-1 pb-1 mb-1 border-b border-slate-700
                 text-[10px] text-slate-300 font-semibold">
          <div>Dist</div>
          <div class="text-center">Elev (mil)</div>
          <div class="text-center">Wind (mil)</div>
        </div>

        <!-- Rows -->
        <div
          *ngFor="let row of editSession.dope; let i = index"
          class="grid grid-cols-[60px,1fr,1fr] gap-1 text-[10px] text-slate-200
                 pb-1 border-b border-slate-800 last:border-0">

          <!-- Distance ONLY -->
          <div class="font-semibold leading-tight flex items-center">
            {{ row.distanceM }} m
          </div>

          <!-- Elevation – very compact box -->
          <div class="flex justify-center items-center">
            <input
              type="number"
              step="0.01"
              [(ngModel)]="row.elevationMil"
              class="w-16 text-center px-1 py-[2px] rounded bg-slate-950 border border-slate-700
                     text-[10px] leading-tight" />
          </div>

          <!-- Windage – very compact box -->
          <div class="flex justify-center items-center">
            <input
              type="number"
              step="0.01"
              [(ngModel)]="row.windageMil"
              class="w-16 text-center px-1 py-[2px] rounded bg-slate-950 border border-slate-700
                     text-[10px] leading-tight" />
          </div>

          <!-- Notes – full width, ultra compact -->
          <div class="col-span-3 mt-1">
            <textarea
              rows="1"
              [(ngModel)]="row.impactsDescription"
              class="w-full px-1 py-1 rounded bg-slate-950 border border-slate-700
                     text-[9px] leading-tight"
              placeholder="Notes (optional)"></textarea>
          </div>

        </div>
      </div>
    </div>

    <!-- Session notes -->
    <label class="flex flex-col mt-2">
      Session notes
      <textarea
        [(ngModel)]="editSession.notes"
        rows="3"
        class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700"></textarea>
    </label>

    <!-- Close button (replaces Save, hides details & returns to list) -->
    <div class="mt-3">
      <button
        class="w-full px-3 py-2 rounded-xl bg-orange-500 text-black text-sm font-semibold"
        (click)="editSession = null">
        Close
      </button>
    </div>
  </div>

</div>
