<div class="space-y-3 text-xs">

  <!-- Add Rifle header card -->
  <div class="bg-slate-800 rounded-2xl p-3 shadow flex items-center justify-between">
    <div class="text-sm font-semibold">Add Rifle</div>
    <button
      class="px-3 py-1 rounded-xl bg-slate-100 text-slate-900 text-xs font-semibold"
      (click)="toggleForm()">
      {{ formVisible ? 'Hide' : 'Show' }}
    </button>
  </div>

  <!-- Rifle form (details only, no load data) -->
  <div *ngIf="formVisible" class="bg-slate-800 rounded-2xl p-3 shadow space-y-2">
    <div class="grid grid-cols-2 gap-2">
      <label class="flex flex-col">
        Name
        <input
          [(ngModel)]="form.name"
          name="name"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Caliber
        <input
          [(ngModel)]="form.caliber"
          name="caliber"
          placeholder="33XC, 6.5 Creed, etc."
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>
    </div>

    <div class="grid grid-cols-3 gap-2">
      <label class="flex flex-col">
        Barrel length
        <div class="flex gap-1 mt-1">
          <input
            type="number"
            [(ngModel)]="form.barrelLength"
            name="barrelLength"
            class="flex-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
          <select
            [(ngModel)]="form.barrelLengthUnit"
            name="barrelLengthUnit"
            class="px-2 py-1 rounded bg-slate-900 border border-slate-700">
            <option value="cm">cm</option>
            <option value="in">in</option>
          </select>
        </div>
      </label>

      <label class="flex flex-col">
        Twist rate
        <input
          [(ngModel)]="form.twistRate"
          name="twistRate"
          placeholder="1:9"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        MV (fps)
        <input
          type="number"
          [(ngModel)]="form.muzzleVelocityFps"
          name="mvFps"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>
    </div>

    <div class="grid grid-cols-2 gap-2">
      <label class="flex flex-col">
        Scope
        <input
          [(ngModel)]="form.scope"
          name="scope"
          placeholder="Scope model"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Scope unit
        <select
          [(ngModel)]="form.scopeClickUnit"
          name="scopeUnit"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700">
          <option *ngFor="let u of clickUnits" [ngValue]="u">{{ u }}</option>
        </select>
      </label>
    </div>

    <div class="grid grid-cols-3 gap-2">
      <label class="flex flex-col">
        Bullet name / type
        <input
          [(ngModel)]="form.bulletName"
          name="bulletName"
          placeholder="300gr Berger Hybrid"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Bullet weight (gr)
        <input
          type="number"
          [(ngModel)]="form.bulletWeightGr"
          name="bulletWeight"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Bullet BC
        <input
          type="number"
          step="0.001"
          [(ngModel)]="form.bulletBc"
          name="bulletBc"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>
    </div>

    <label class="flex flex-col">
      Notes
      <textarea
        [(ngModel)]="form.notes"
        rows="2"
        class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700"></textarea>
    </label>

    <div class="flex justify-end gap-2 mt-2">
      <button
        class="px-3 py-1 text-xs rounded bg-slate-700"
        (click)="formVisible = false; editing = null;">
        Cancel
      </button>
      <button
        class="px-3 py-1 text-xs rounded bg-emerald-500 text-slate-900 font-semibold"
        (click)="save()">
        {{ editing ? 'Save changes' : 'Add rifle' }}
      </button>
    </div>
  </div>

  <!-- Stored rifles list -->
  <div class="bg-slate-800 rounded-2xl p-3 shadow space-y-2">
    <h2 class="text-sm font-semibold mb-1">
      Stored Rifles ({{ rifles.length }})
    </h2>

    <div *ngIf="rifles.length === 0" class="text-[11px] text-slate-400">
      No rifles saved yet. Use "Add Rifle" above.
    </div>

    <div
      *ngFor="let r of rifles"
      class="bg-slate-900 rounded-2xl p-3 mt-1 space-y-2">

      <!-- Header row: name + caliber + action buttons -->
      <div class="flex justify-between items-center">
        <div>
          <div class="text-sm font-semibold">
            {{ r.name }}
            <span class="text-slate-300">({{ r.caliber }})</span>
          </div>
        </div>
        <div class="flex gap-2 text-[11px]">
          <button
            class="px-2 py-1 rounded bg-slate-700"
            (click)="edit(r)">
            Edit
          </button>
          <button
            class="px-2 py-1 rounded bg-slate-700"
            (click)="duplicate(r)">
            Copy
          </button>
          <button
            class="px-2 py-1 rounded bg-red-600"
            (click)="delete(r)">
            Delete
          </button>
        </div>
      </div>

      <!-- Summary chips -->
      <div class="flex flex-wrap gap-2 text-[11px]">
        <span class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          {{ r.caliber }}
        </span>
        <span *ngIf="r.barrelLength"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          Barrel {{ r.barrelLength }} {{ r.barrelLengthUnit || 'cm' }}
        </span>
        <span *ngIf="r.twistRate"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          Twist {{ r.twistRate }}
        </span>
        <span *ngIf="r.muzzleVelocityFps"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          {{ r.muzzleVelocityFps }} fps
        </span>
        <span *ngIf="r.bulletWeightGr"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          {{ r.bulletWeightGr }} gr
        </span>
        <span *ngIf="r.bulletBc"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          BC {{ r.bulletBc }}
        </span>
        <span *ngIf="r.scopeClickUnit"
              class="px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
          {{ r.scopeClickUnit }}
        </span>
      </div>

      <!-- Load data tab button -->
      <div class="flex justify-between items-center mt-1">
        <div class="text-[11px] font-semibold">
          Load data ({{ r.loads?.length || 0 }})
        </div>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 rounded-xl bg-slate-100 text-slate-900 text-[11px] font-semibold"
            (click)="toggleLoads(r)">
            {{ loadsExpandedId === r.id ? 'Hide' : 'Show' }}
          </button>
          <button
            class="px-3 py-1 rounded-xl bg-emerald-500 text-slate-900 text-[11px] font-semibold"
            (click)="startAddLoad(r)">
            Add load
          </button>
        </div>
      </div>

      <!-- Load data panel -->
      <div *ngIf="loadsExpandedId === r.id" class="mt-2 bg-slate-950 rounded-xl p-2 space-y-2">
        <!-- Existing loads -->
        <div *ngIf="r.loads && r.loads.length > 0; else noLoads" class="space-y-1">
          <div
            *ngFor="let ld of r.loads"
            class="flex justify-between items-start bg-slate-900 rounded-lg p-2 text-[11px]">
            <div>
              <div>
                <span class="font-semibold">Powder:</span> {{ ld.powder }}
              </div>
              <div>
                <span class="font-semibold">Charge:</span> {{ ld.powderChargeGr }} gn
              </div>
              <div *ngIf="ld.coal">
                <span class="font-semibold">COAL:</span> {{ ld.coal }}
              </div>
              <div *ngIf="ld.primer">
                <span class="font-semibold">Primer:</span> {{ ld.primer }}
              </div>
            </div>
            <div class="flex flex-col gap-1">
              <button
                class="px-2 py-1 rounded bg-slate-700"
                (click)="startEditLoad(r, ld)">
                Edit
              </button>
              <button
                class="px-2 py-1 rounded bg-red-600"
                (click)="deleteLoad(r, ld)">
                Delete
              </button>
            </div>
          </div>
        </div>
        <ng-template #noLoads>
          <div class="text-[11px] text-slate-400">
            No load data yet for this rifle.
          </div>
        </ng-template>

        <!-- Load editor -->
        <div class="border-t border-slate-800 pt-2 mt-2 space-y-2">
          <div class="text-[11px] font-semibold">
            {{ editingLoadId != null ? 'Edit load' : 'Add load' }}
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="flex flex-col">
              Powder
              <input
                [(ngModel)]="loadForm.powder"
                name="powder"
                class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
            </label>

            <label class="flex flex-col">
              Charge (gn)
              <input
                type="number"
                step="0.01"
                [(ngModel)]="loadForm.powderChargeGr"
                name="powderChargeGr"
                class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
            </label>

            <label class="flex flex-col">
              COAL
              <input
                [(ngModel)]="loadForm.coal"
                name="coal"
                placeholder='e.g. 3.456"'
                class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
            </label>

            <label class="flex flex-col">
              Primer
              <input
                [(ngModel)]="loadForm.primer"
                name="primer"
                placeholder="Primer type"
                class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
            </label>
          </div>

          <div class="flex justify-end gap-2">
            <button
              class="px-3 py-1 text-xs rounded bg-slate-700"
              (click)="editingLoadId = null; loadForm = {}">
              Clear
            </button>
            <button
              class="px-3 py-1 text-xs rounded bg-emerald-500 text-slate-900"
              (click)="saveLoad(r)">
              {{ editingLoadId != null ? 'Save load' : 'Add load' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Optional rifle notes -->
      <div *ngIf="r.notes" class="text-[11px] text-slate-300 mt-1">
        <span class="font-semibold">Notes:</span> {{ r.notes }}
      </div>
    </div>
  </div>
</div>
