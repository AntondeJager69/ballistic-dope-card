<div class="space-y-3 text-xs">

  <!-- Add / Edit Rifle header -->
  <div class="bg-slate-800 rounded-2xl p-3 shadow flex items-center justify-between">
    <div class="text-sm font-semibold">
      {{ editingRifle ? 'Edit Rifle' : 'Add Rifle' }}
    </div>
    <button
      class="px-3 py-1 rounded-xl bg-slate-100 text-slate-900 text-xs font-semibold"
      (click)="toggleAddForm()">
      {{ addFormVisible ? 'Hide' : 'Show' }}
    </button>
  </div>

  <!-- Rifle form -->
  <div *ngIf="addFormVisible" class="bg-slate-800 rounded-2xl p-3 shadow space-y-2">

    <div class="grid grid-cols-2 gap-2">
      <label class="flex flex-col">
        Name
        <input
          [(ngModel)]="rifleForm.name"
          name="name"
          placeholder="e.g. 6.5 CM ELR"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Caliber
        <input
          [(ngModel)]="rifleForm.caliber"
          name="caliber"
          placeholder="e.g. 6.5 Creedmoor"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Barrel length
        <input
          type="number"
          [(ngModel)]="rifleForm.barrelLength"
          name="barrelLength"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Barrel unit
        <select
          [(ngModel)]="rifleForm.barrelUnit"
          name="barrelUnit"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700">
          <option value="cm">cm</option>
          <option value="inch">inch</option>
        </select>
      </label>

      <label class="flex flex-col">
        Twist rate
        <input
          [(ngModel)]="rifleForm.twistRate"
          name="twistRate"
          placeholder="e.g. 1:8"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Muzzle velocity (fps)
        <input
          type="number"
          [(ngModel)]="rifleForm.muzzleVelocityFps"
          name="muzzleVelocity"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>

      <label class="flex flex-col">
        Scope unit
        <select
          [(ngModel)]="rifleForm.scopeUnit"
          name="scopeUnit"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700">
          <option value="MIL">MIL</option>
          <option value="MOA">MOA</option>
        </select>
      </label>

      <label class="flex flex-col">
        Round count
        <input
          type="number"
          [(ngModel)]="rifleForm.roundCount"
          name="roundCount"
          placeholder="Total rounds fired so far"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" />
      </label>
    </div>

    <label class="flex flex-col">
      Notes
      <textarea
        [(ngModel)]="rifleForm.notes"
        name="notes"
        rows="2"
        class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700"></textarea>
    </label>

    <div class="flex justify-end gap-2 mt-2">
      <button
        class="px-3 py-1 text-xs rounded bg-slate-700"
        (click)="clearRifleForm()">
        Cancel
      </button>
      <button
        class="px-3 py-1 text-xs rounded bg-emerald-500 text-slate-900 font-semibold"
        (click)="saveRifle()">
        {{ editingRifle ? 'Save changes' : 'Add rifle' }}
      </button>
    </div>
  </div>

  <!-- Stored rifles (selector + single expanded card) -->
  <div class="bg-slate-800 rounded-2xl p-3 shadow space-y-2">
    <div class="flex justify-between items-center mb-1">
      <div class="text-xs font-semibold">Rifles</div>
      <div class="text-[11px] text-slate-300">
        Total: {{ rifles.length }}
      </div>
    </div>

    <ng-container *ngIf="rifles.length > 0; else noRifles">
      <label class="flex flex-col text-[11px] mb-2">
        Select rifle
        <select
          [(ngModel)]="selectedRifleId"
          (ngModelChange)="onSelectedRifleChange($event)"
          name="selectedRifle"
          class="mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700">
          <option *ngFor="let r of rifles" [ngValue]="r.id">
            {{ r.name }} ({{ r.caliber }})
          </option>
        </select>
      </label>

      <!-- Only the selected rifle expands -->
      <div *ngIf="selectedRifle as r" class="bg-slate-900 rounded-2xl p-3 border border-slate-700 space-y-2">
        <div class="flex justify-between items-start gap-2">
          <div class="space-y-0.5">
            <div class="text-xs font-semibold">
              {{ r.name }} <span class="text-[10px] text-slate-300">({{ r.caliber }})</span>
            </div>
            <div class="text-[10px] text-slate-300">
              Barrel: {{ r.barrelLength || '-' }} {{ r.barrelUnit || 'cm' }} • Twist: {{ r.twistRate || '-' }}
            </div>
            <div class="text-[10px] text-slate-300">
              Scope: {{ r.scopeUnit }} • Muzzle: {{ r.muzzleVelocityFps || '-' }} fps
            </div>
            <div class="text-[10px] text-slate-300">
              Rounds: {{ r.roundCount ?? 0 }}
            </div>
          </div>

          <div class="flex flex-col gap-1 text-[10px]">
            <button
              class="px-2 py-1 rounded bg-slate-700"
              (click)="editRifle(r)">
              Edit
            </button>
            <button
              class="px-2 py-1 rounded bg-rose-500 text-slate-900"
              (click)="deleteRifle(r)">
              Delete
            </button>
          </div>
        </div>

        <!-- Loads for this rifle -->
        <div class="mt-2 border-t border-slate-700 pt-2">
          <button
            class="text-[11px] underline"
            (click)="toggleLoads(r)">
            {{ activeLoadsRifleId === r.id ? 'Hide load data' : 'Show load data' }}
          </button>

          <div *ngIf="activeLoadsRifleId === r.id" class="mt-2 space-y-2">
            <div class="text-[11px] text-slate-300">
              Defined loads: {{ (r.loads || []).length }}
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full text-[10px] border-collapse">
                <thead>
                  <tr class="bg-slate-900 border-b border-slate-700">
                    <th class="px-2 py-1 text-left font-semibold">Powder</th>
                    <th class="px-2 py-1 text-left font-semibold">Charge</th>
                    <th class="px-2 py-1 text-left font-semibold">COAL</th>
                    <th class="px-2 py-1 text-left font-semibold">Primer</th>
                    <th class="px-2 py-1 text-left font-semibold">Bullet</th>
                    <th class="px-2 py-1"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let l of r.loads"
                    class="border-b border-slate-800">
                    <td class="px-2 py-1">{{ l.powder }}</td>
                    <td class="px-2 py-1">{{ l.chargeGn }}</td>
                    <td class="px-2 py-1">{{ l.coal }}</td>
                    <td class="px-2 py-1">{{ l.primer }}</td>
                    <td class="px-2 py-1">
                      <span *ngIf="l.bulletWeightGr || l.bullet; else noBullet">
                        <span *ngIf="l.bulletWeightGr">{{ l.bulletWeightGr }} gr </span>{{ l.bullet }}
                        <span *ngIf="l.bulletBc"> (BC {{ l.bulletBc }})</span>
                      </span>
                      <ng-template #noBullet>
                        <span class="text-[9px] text-slate-500">–</span>
                      </ng-template>
                    </td>
                    <td class="px-2 py-1">
                      <button
                        class="px-2 py-0.5 mr-1 rounded bg-slate-700"
                        (click)="editLoad(r, l)">
                        Edit
                      </button>
                      <button
                        class="px-2 py-0.5 rounded bg-rose-500 text-slate-900"
                        (click)="deleteLoad(r, l)">
                        Del
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Toggle for load edit/add form -->
            <button
              class="text-[11px] underline mt-1"
              (click)="toggleLoadForm(r.id)">
              {{ activeLoadFormRifleId === r.id ? 'Hide add/edit load form' : 'Show add/edit load form' }}
            </button>

            <!-- Load edit/add form (collapsed by default) -->
            <div
              *ngIf="activeLoadFormRifleId === r.id"
              class="bg-slate-900 rounded-xl p-2 space-y-2">
              <div class="text-[11px] font-semibold">
                {{ editingLoadId ? 'Edit load data' : 'Add load data' }}
              </div>

              <div class="grid grid-cols-2 gap-2">
                <label class="flex flex-col">
                  Powder
                  <input
                    [(ngModel)]="loadForm.powder"
                    name="loadPowder"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  Charge (gr)
                  <input
                    type="number"
                    [(ngModel)]="loadForm.chargeGn"
                    name="loadCharge"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  COAL
                  <input
                    [(ngModel)]="loadForm.coal"
                    name="loadCoal"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  Primer
                  <input
                    [(ngModel)]="loadForm.primer"
                    name="loadPrimer"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  Bullet
                  <input
                    [(ngModel)]="loadForm.bullet"
                    name="loadBullet"
                    placeholder="e.g. 140 ELD-M"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  Bullet weight (gr)
                  <input
                    type="number"
                    [(ngModel)]="loadForm.bulletWeightGr"
                    name="loadBulletWeight"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>

                <label class="flex flex-col">
                  BC
                  <input
                    [(ngModel)]="loadForm.bulletBc"
                    name="loadBulletBc"
                    placeholder="e.g. 0.345 G7"
                    class="mt-1 px-2 py-1 rounded bg-slate-950 border border-slate-700" />
                </label>
              </div>

              <div class="flex justify-end gap-2">
                <button
                  class="px-3 py-1 text-[11px] rounded bg-slate-700"
                  (click)="resetLoadForm()">
                  Clear
                </button>
                <button
                  class="px-3 py-1 text-[11px] rounded bg-emerald-500 text-slate-900 font-semibold"
                  (click)="saveLoad(r)">
                  {{ editingLoadId ? 'Save load' : 'Add load' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="r.notes" class="mt-2 text-[11px] text-slate-300">
          Notes: {{ r.notes }}
        </div>
      </div>
    </ng-container>

    <ng-template #noRifles>
      <div class="text-[11px] text-slate-300">
        No rifles yet. Add one above.
      </div>
    </ng-template>
  </div>
</div>
