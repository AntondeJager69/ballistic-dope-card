<div
  class="flex flex-col h-full w-full text-slate-200"
  [style.touchAction]="'none'">

  <!-- Header / instructions -->
  <div class="mb-3 flex flex-col items-center gap-1">
    <div class="text-xs font-semibold uppercase tracking-wide">
      Wind effect visualiser
    </div>
    <div class="text-[10px] text-slate-400 text-center max-w-xs">
      Target is always at
      <span class="font-semibold text-slate-200">12 o'clock</span>.
      Choose rifle, distance and wind, then drag the arrow around the circle.
      The red dot shows approximate point-of-impact shift from crosswind.
    </div>
  </div>

  <!-- Rifle + inputs -->
  <div class="mb-3 space-y-2 text-xs">

    <!-- Rifle selection (TOP) -->
    <div class="flex justify-center">
      <label class="flex flex-col">
        <span class="text-[10px] text-slate-300 mb-1 text-center">
          Rifle
        </span>
        <select
          [(ngModel)]="selectedRifleId"
          class="min-w-[180px] bg-black border border-slate-600 rounded px-2 py-1 text-[10px]">
          <option [ngValue]="null">No rifle / generic</option>
          <option *ngFor="let r of rifles" [ngValue]="r.id">
            {{ r.name }} • {{ r.caliber }}
          </option>
        </select>
      </label>
    </div>

    <!-- Distance + wind speed + wind direction (aligned row) -->
    <div class="flex justify-center">
      <div class="grid grid-cols-3 gap-3 w-full max-w-xs">

        <!-- Distance -->
        <label class="flex flex-col items-center">
          <span class="text-[10px] text-slate-300 mb-1 text-center">
            Distance
          </span>
          <input
            type="number"
            min="50"
            step="50"
            class="w-20 bg-black border border-slate-600 rounded px-1 py-0.5 text-center text-[11px]"
            [(ngModel)]="distanceM" />
          <span class="text-[9px] text-slate-500 mt-0.5">
            meters
          </span>
        </label>

        <!-- Wind speed -->
        <label class="flex flex-col items-center">
          <span class="text-[10px] text-slate-300 mb-1 text-center">
            Wind speed
          </span>
          <input
            type="number"
            class="w-20 bg-black border border-slate-600 rounded px-1 py-0.5 text-center text-[11px]"
            [(ngModel)]="windSpeed"
            (ngModelChange)="onWindSpeedChange($event)" />
          <span class="text-[9px] text-slate-500 mt-0.5">
            m/s
          </span>
        </label>

        <!-- Wind from (clock) -->
        <label class="flex flex-col items-center">
          <span class="text-[10px] text-slate-300 mb-1 text-center">
            Wind from
          </span>
          <input
            type="number"
            min="1"
            max="12"
            class="w-20 bg-black border border-slate-600 rounded px-1 py-0.5 text-center text-[11px]"
            [(ngModel)]="windClock"
            (ngModelChange)="onWindClockChange()" />
          <span class="text-[9px] text-slate-500 mt-0.5">
            o'clock
          </span>
        </label>

      </div>
    </div>
  </div>

  <!-- Circle, fat arrow, POI -->
  <div class="flex-1 flex items-center justify-center">
    <div
      #circle
      class="relative"
      [style.width.px]="circleDiameter"
      [style.height.px]="circleDiameter"
      (pointerdown)="onCirclePointerDown($event)">

      <!-- Outer circle -->
      <div class="absolute inset-0 rounded-full border border-slate-600"></div>

      <!-- Crosshair lines -->
      <div class="absolute inset-x-1/2 -translate-x-1/2 top-0 bottom-0 border-l border-dashed border-slate-700"></div>
      <div class="absolute inset-y-1/2 -translate-y-1/2 left-0 right-0 border-t border-dashed border-slate-700"></div>

      <!-- Target notch at 12 o'clock -->
      <div class="absolute left-1/2 -translate-x-1/2 top-0">
        <div class="w-[12px] h-[4px] bg-slate-300 rounded-b"></div>
      </div>

      <!-- FAT ARROW on outer ring (drag handle) -->
      <div
        class="absolute left-1/2 top-1/2"
        [style.transform]="
          'translate(-50%, -50%) rotate(' +
          windAngleDeg +
          'deg) translate(0,' +
          (-arrowRadius) +
          'px)'
        ">
        <!-- Larger hit area for finger -->
        <div class="w-10 h-10 flex flex-col items-center justify-center active:scale-110">
          <!-- Short shaft pointing towards centre -->
          <div class="w-[4px] h-[11px] bg-amber-300 mb-[2px] rounded-full shadow-[0_0_4px_rgba(251,191,36,0.8)]"></div>
          <!-- ELR-style arrow head pointing INWARDS (towards centre) -->
          <div
            class="w-0 h-0 border-l-[13px] border-r-[13px] border-t-[22px]
                   border-l-transparent border-r-transparent border-t-amber-300
                   drop-shadow-[0_0_6px_rgba(251,191,36,0.9)]">
          </div>
        </div>
      </div>

      <!-- POI shift (red dot) -->
      <div
        class="absolute left-1/2 top-1/2"
        [style.transform]="
          'translate(calc(-50% + ' +
          impactX +
          'px), calc(-50% + ' +
          impactY +
          'px))'
        ">
        <div class="w-3 h-3 rounded-full bg-red-500 shadow"></div>
      </div>
    </div>
  </div>

  <!-- Approx drift summary (HIGHLIGHTED, just under circle) -->
  <div
    *ngIf="approxDriftMil !== null && selectedRifle"
    class="mt-3 mx-auto max-w-xs">
    <div
      class="rounded-xl bg-amber-500/15 border border-amber-400/70 px-3 py-2
             text-[10px] text-center shadow-[0_0_8px_rgba(251,191,36,0.35)]">
      <div class="font-semibold text-amber-200 mb-1">
        Approx. drift for {{ selectedRifle.name }} @ {{ distanceM }} m
      </div>
      <div class="text-[11px]">
        <span class="font-bold text-amber-300 text-[12px]">
          {{ approxDriftMil }} mil
        </span>
        <span class="ml-1 text-slate-200">
          ({{ driftDirectionLabel }})
        </span>
      </div>
    </div>
  </div>

  <!-- Crosswind summary (plain, under highlighted drift) -->
  <div class="mt-2 text-[10px] text-center text-slate-300">
    Crosswind component:
    <span class="font-semibold">{{ crosswindPercent }}%</span>
    of a pure 90° crosswind.
  </div>

  <!-- Legend -->
  <div class="mt-3 text-[10px] text-slate-400 text-center px-2">
    <span class="inline-flex items-center gap-1 mr-3">
      <!-- Arrow legend -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        class="w-3 h-3">
        <circle
          cx="12"
          cy="12"
          r="10"
          class="fill-transparent stroke-amber-300"
          stroke-width="1" />
        <path
          d="M12 4 L12 12 L8 8"
          class="stroke-amber-300"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
      Wind FROM this direction
    </span>

    <span class="inline-flex items-center gap-1">
      <span class="w-2.5 h-2.5 rounded-full bg-red-500 inline-block"></span>
      Approximate POI shift on target
    </span>
  </div>
</div>
